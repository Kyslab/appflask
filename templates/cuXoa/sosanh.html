<!doctype html>
<html>
<head>
    <title>Upload and List Files</title>
    <script src="https://www.paypal.com/sdk/js?client-id=YOUR_PAYPAL_CLIENT_ID"></script>
</head>
<body>

    <h1>Welcome to the Mergexcel online tool</h1>

    {% if user %}
        <p>Email: {{ user.email }}</p>
        <p>Balance: ${{ user.balance }}</p>
        <div id="paypal-button-container"></div>
        <a href="{{ url_for('deposit') }}">Deposit</a>
    {% endif %}

    <h1>Upload and List Files</h1>
    <form method="POST" enctype="multipart/form-data">
        <p>
            <input type="file" name="files" multiple>
        </p>
        <p><input type="submit" value="Upload Files"></p>
    </form>

    <h2>Files:</h2>
    <form method="POST">
        <ul>
            {% for file in files %}
                <li>
                    {{ file }}
                    <input type="hidden" name="file_names" value="{{ file }}">
                    <select name="sheets_{{ loop.index0 }}">
                        {% for sheet in file_sheets[file] %}
                            <option value="{{ sheet }}">{{ sheet }}</option>
                        {% endfor %}
                    </select>
                    <form method="POST" action="{{ url_for('delete_file', filename=file) }}" style="display: inline;">
                        <button type="submit">Delete</button>
                    </form>
                </li>
            {% endfor %}
        </ul>

        <input type="hidden" name="merge">
        <p>
            <input type="checkbox" name="remove_empty"> Remove Empty Rows
        </p>
        <div id="text_to_remove_container">
            <p>
                <input type="checkbox" name="text_to_remove" checked>
                <input type="text" name="text_to_remove">
                <button type="button" id="add_text_to_remove">+</button>
            </p>
        </div>
        <p><input type="submit" value="Merge Files"></p>
    </form>

    <a href="{{ url_for('logout') }}">Logout</a>

    <script>
        document.getElementById('add_text_to_remove').addEventListener('click', function () {
            var container = document.getElementById('text_to_remove_container');
            var new_input = document.createElement('p');
            new_input.innerHTML = '<input type="checkbox" name="text_to_remove" checked> <input type="text" name="text_to_remove">';
            container.appendChild(new_input);
        });

        // Render the PayPal button into #paypal-button-container
        paypal.Buttons({
            createOrder: function(data, actions) {
                // Set up the transaction
                return actions.order.create({
                    purchase_units: [{
                        amount: {
                            value: '10.00' // Set the amount you want to charge here
                        }
                    }]
                });
            },
            onApprove: function(data, actions) {
                // Capture the funds from the transaction
                return actions.order.capture().then(function(details) {
                    // Call your server to save the transaction
                    return fetch('/paypal-transaction-complete', {
                        method: 'post',
                        headers: {
                            'content-type': 'application/json'
                        },
                        body: JSON.stringify({
                            orderID: data.orderID,
                            details: details
                        })
                    }).then(function(response) {
                        if (response.ok) {
                            alert('Transaction completed by ' + details.payer.name.given_name);
                            location.reload(); // Reload the page to update the balance
                        } else {
                            alert('Transaction failed');
                        }
                    });
                });
            }
        }).render('#paypal-button-container');
    </script>
</body>
</html>
