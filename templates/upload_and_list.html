<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload and List Files</title>
    <script src="https://www.paypal.com/sdk/js?client-id=AQ4anPK0Dv374JlrBVbRHwm4JtPRJ6n1hk8myO9NbkXCLSu5bD3VjC4bDD-UOfYIAP0xHA1JbgN57vBA"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body {
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: auto;
        }
        .file-list {
            list-style-type: none;
            padding: 0;
        }
        .file-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1 class="my-4">Mergexcel Online Tool</h1>

        {% if user %}
            <div class="alert alert-info">
                <p>Email: {{ user.email }}</p>
                <p>Balance: ${{ user.balance }}</p>
                <label for="amount">Amount to deposit:</label>
                <input type="number" id="amount" name="amount" min="1" step="0.01">
                <div id="paypal-button-container"></div>
                <a href="{{ url_for('deposit') }}" class="btn btn-primary">Deposit</a>
            </div>
        {% endif %}

        <h2 class="my-4">Upload Files</h2>
        <form method="POST" enctype="multipart/form-data">
            <div class="form-group">
                <input type="file" name="files" multiple class="form-control-file">
            </div>
            <button type="submit" class="btn btn-success">Upload Files</button>
        </form>

        <h2 class="my-4">Uploaded Files</h2>
        <ul class="file-list">
            {% for file in files %}
                <li>
                    {{ file }}
                        
                    <form method="POST" action="{{ url_for('delete_file', filename=file) }}" class="ml-2">
                        <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                    </form>
                </li>
            {% endfor %}
        </ul>

        <h2 class="my-4">Option for Merge Files</h2>
        <form method="POST">
            {% for file in files %}
            <li>
                {{ file }}
                <input type="hidden" name="file_names" value="{{ file }}">
                <select name="sheets_{{ loop.index0 }}" class="ml-2">
                    {% for sheet in file_sheets[file] %}
                        <option value="{{ sheet }}">{{ sheet }}</option>
                    {% endfor %}
                </select>
                
            </li>
            {% endfor %}


            <input type="hidden" name="merge">
            <div class="form-check mb-2">
                <input type="checkbox" name="remove_empty" class="form-check-input" id="remove_empty">
                <label for="remove_empty" class="form-check-label">Remove Empty Rows</label>
            </div>
            <a>Remove rows if its got following text :</a>
            <div id="text_to_remove_container" class="mb-2">
                <div class="input-group mb-2">
                    <div class="input-group-prepend">
                        <div class="input-group-text">
                            <input type="checkbox" name="text_to_remove" checked>
                        </div>
                    </div>
                    <input type="text" name="text_to_remove" class="form-control">
                </div>
            </div>
            <button type="button" id="add_text_to_remove" class="btn btn-secondary mb-2">+</button>
            <a>add_text_to_remove</a>
        </br>
        <p> 
            <button type="submit" class="btn btn-primary">Merge Files</button>
            <span>Total Cost: ${{ total_cost }}</span>
        </p>
        </form>

        <a href="{{ url_for('logout') }}" class="btn btn-link mt-4">Logout</a>
    </div>

    <script>
        document.getElementById('add_text_to_remove').addEventListener('click', function () {
            var container = document.getElementById('text_to_remove_container');
            var new_input = document.createElement('div');
            new_input.className = 'input-group mb-2';
            new_input.innerHTML = '<div class="input-group-prepend"><div class="input-group-text"><input type="checkbox" name="text_to_remove" checked></div></div><input type="text" name="text_to_remove" class="form-control">';
            container.appendChild(new_input);
        });
        
        // Render the PayPal button into #paypal-button-container
        paypal.Buttons({
            createOrder: function(data, actions) {
                var amount = document.getElementById('amount').value;
                if (!amount || amount <= 0) {
                    alert('Please enter a valid amount.');
                    return;
                }
                return actions.order.create({
                    purchase_units: [{
                        amount: {
                            value: amount
                        }
                    }]
                });
            },
            onApprove: function(data, actions) {
                return actions.order.capture().then(function(details) {
                    return fetch('/paypal-transaction-complete', {
                        method: 'post',
                        headers: {
                            'content-type': 'application/json'
                        },
                        body: JSON.stringify({
                            orderID: data.orderID,
                            details: details,
                            amount: document.getElementById('amount').value
                        })
                    }).then(function(response) {
                        if (response.ok) {
                            alert('Transaction completed by ' + details.payer.name.given_name);
                            location.reload(); // Reload the page to update the balance
                        } else {
                            alert('Transaction failed');
                        }
                    });
                });
            }
        }).render('#paypal-button-container');
    

    </script>
</body>
</html>
